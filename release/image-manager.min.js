!function(e,n){"function"==typeof define&&define.amd?define("image-manager",["cachelru"],function(){return e.ImageManager=n()}):"object"==typeof module&&module.exports?module.exports=e.ImageManager=n():e.ImageManager=n()}(this,function(){"use strict";function e(){}function n(){}function t(){}function r(){function e(){n.iframe=document.createElement("iframe");n.iframe.setAttribute("src","");n.iframe.style.setProperty("display","none","");n.iframe.onload=function(){n.iframe.onload=null;n.image=document.createElement("img");(n.iframe.contentDocument||n.iframe.contentWindow).body.appendChild(n.image);n.image.onload=function(){if(n.source&&n.image.src===n.source){n.isLoading=!1;n.image.onload=null;return n.onLoad(n.image)}}.bind(n);n.image.onerror=function(){n.isLoading=!1;n.image.onerror=null;return n.onFailure(n.image)}.bind(n)}.bind(n);document.body.appendChild(n.iframe)}var n=this;n.iframe=null;n.image=null;n.isLoading=!1;n.source=null;n.destructor=function(){n.cancelRequest();n.isLoading=!1;n.source=null;n.image=null;document.body.removeChild(n.iframe);n.iframe=null};n.cancelRequest=function(){var e;if(n.isLoading&&n.image){e=n.iframe.contentWindow;if(e.stop)e.stop();else{e=n.iframe.contentDocument;e.execCommand&&e.execCommand("Stop",!1)}}return n.isLoading=!1};n.load=function(t,r,o){n.iframe||e();var i;if(n.image){n.source=t;n.onLoad=r;n.onFailure=o;if(n.image.src!==t){n.cancelRequest();n.isLoading=!0;return n.image.src=t}if(n.image.complete){n.cancelRequest();r(n.image)}}else{i=new Image;i.onload=function(){return r(i)};i.onerror=function(){return o(i)};i.src=t}}}function o(n,o){function i(n,t){c.id=e.getInPath(n,"id",0);0===c.id&&a&&console.warn("ImageLoader->constructor() - ID is empty");c.src=e.getInPath(n,"src","");(!c.src||c.src.length<5)&&a&&console.warn("ImageLoader->constructor() - SRC is empty");c.fullRepeal=e.getInPath(n,"fullRepeal",t.fullRepeal);c.onSuccess=e.getInPath(n,"onSuccess",t.onSuccess);c.onError=e.getInPath(n,"onError",t.onError);c.onResolve=e.getInPath(n,"onResolve",t.onResolve);c.maxDownloads=e.toNumber(e.getInPath(n,"maxDownloads",t.maxDownloads),t.maxDownloads,1);c.isPaused=e.getInPath(n,"isPaused",t.isPaused)}var c=this;c.id;c.src;c.fullRepeal=!1;c.isPaused=!1;c.onSuccess=null;c.onError=null;c.onResolve=null;c.maxDownloads=1;c.currentDownloads=0;c.image;c.completed=!1;c.isLoadingStarted=!1;i(n,o);c.dispatchLoading=function(){if(c.isPaused)return!1;c.isLoadingStarted=!0;if(t.isCached(c.src)){a&&console.info("ImageLoader->dispatchLoading() - Image is already in cache: "+c.src);c.onLoad();return!0}c.initImage();return!0};c.initImage=function(){if(c.fullRepeal){c.image.src=c.src;c.image=new r;c.image.load(c.src,c.onLoad.bind(c),c.onFailed.bind(c))}else{c.image=new Image;c.image.src=c.src;c.image.onload=c.onLoad.bind(c);c.image.onerror=c.onFailed.bind(c)}};c.getImageinfo=function(){return{id:c.id,src:c.src,completed:c.completed}};c.onLoad=function(){c.completed=!0;c.image=null;a&&console.info("ImageLoader->onLoad() - Image is loaded: "+c.src);a&&console.dir(c);e.call(c.onSuccess,[c.getImageinfo()]);e.call(c.onComplete,[c])};c.onFailed=function(){c.completed=!1;c.currentDownloads+=1;if(c.currentDownloads>=c.maxDownloads){a&&console.info("ImageLoader->onFailed() - Image is not loaded"+(c.maxDownloads>1?". Attempts were made: "+c.currentDownloads:""));a&&console.dir(c);e.call(c.onError,[c.getImageinfo()]);e.call(c.onComplete,[c])}else{a&&console.info("ImageLoader->onFailed() - Image is not loaded. Attempt "+c.currentDownloads+"/"+c.maxDownloads);a&&console.dir(c);c.initImage()}};c.onComplete=function(){a&&console.warn("ImageLoader->onComplete() - Warning! This is dummy function!");a&&console.dir(c);e.call(c.onResolve,[c.getImageinfo()])};c.onDrop=function(){a&&console.info("ImageLoader->onDrop() - Image loading completed");a&&console.dir(c);c.fullRepeal&&c.image.destructor()}}function i(t,r){function i(e,t){h.configReset();L=new n(t);if(e)if("interactive"===document.readyState||"complete"===document.readyState){a&&console.info("ImageManager->constructor() - Document is't ready");M=!0;c()}else document.addEventListener("DOMContentLoaded",function(){a&&console.info("ImageManager->constructor() - Document ready");M=!0;c()}.bind(h),!1);else{a&&console.info("ImageManager->constructor() - Do not wait for document loading");M=!0;c()}}function c(){if(M)if(h.imageListCurrSize)if(v>=I)a&&console.info("ImageManager->_checkOut() - Now all downloads are active: "+v+" of "+I);else{a&&console.info("ImageManager->_checkOut() - Begin to look through the list");a&&console.dir(e.keys(p));e.keys(p).every(function(e){if(v>=I){a&&console.info("ImageManager->_checkOut() - Skip. All downloads are active: "+v+" of "+I);return!1}if(p[e].isPaused){a&&console.info("ImageManager->_checkOut() - The image in the pause: "+p[e].src);a&&console.dir(p[e])}else if(p[e].isLoadingStarted){a&&console.info("ImageManager->_checkOut() - Image load already started: "+p[e].src);a&&console.dir(p[e])}else{v+=1;p[e].dispatchLoading();a&&console.info("ImageManager->_checkOut() - Image load started: "+p[e].src);a&&console.dir(p[e])}return!0}.bind(h))}else{a&&console.info("ImageManager->_checkOut() - Image list is empty");if(b){a&&console.info("ImageManager->_checkOut() - All operations are carried out, get out of the handler");s()}else a&&console.info("ImageManager->_checkOut() - Emty ID means there was not any operations")}else a&&console.info("ImageManager->_checkOut() - The loader is not active")}function s(){a&&console.info("ImageManager->_onAllDone() - All actions are completed");e.call(h.onFinish,[],h)}function u(n){a&&console.info("ImageManager->_onListSizeChange("+n+")");if(!(h.listSize>=n)&&h.imageListCurrSize){var t=h.listSize,r=h.imageListCurrSize;t>r||e.keys(p).splice(0,r-t).forEach(function(e){p[e].onComplete(p[e])})}}function l(){return h.imageListCurrSize?p[e.keys(p)[0]]:!1}function f(e){a&&console.info("ImageManager->_onDownloadSizeChange("+e+")")}function g(e){return e in p}function m(e,n){a&&console.info("ImageManager->_removeImageFromList() - Remove by src: "+e);a&&console.dir(n);var t=S[e];delete p[t];delete S[e];c()}function d(n){if(e.isArray(n))return e.forEach(n,function(e){return d(e)});if(!g(n)){a&&console.info("ImageManager->_startById() - ID is not exists");return!1}p[n].isPaused=!1;c();return!0}var h=this;if(arguments.length<2){r=50;t=arguments.length?!0:!!t}else r=e.toNumber(r,50,2,e.MAX_NUMBER);var p={},y=e.MAX_NUMBER,I=1,v=0,S={},b=0;h.onFinish=null;var L,M=!1,w={fullRepeal:!1,isPaused:!1,maxDownloads:1,onError:null,onResolve:null,onSuccess:null},R={};h.configGet=function(){return e.extend(R,{})};h.configReset=function(){R=e.extend(w,{})};i(t,r);Object.defineProperty(h,"activeDerived",{get:function(){return I},set:function(n){var t=e.toNumber(n,1,1);if(t!==I){a&&console.info("ImageManager->activeDerived() - The number of active downloads changed from "+I+" to "+t);I=t;f(t)}else a&&console.info("ImageManager->activeDerived() - The number of active downloads hasn't changed: "+t)}});Object.defineProperty(h,"listSize",{get:function(){return y},set:function(n){var t=e.toNumber(n,1,1),r=y;if(t!==r){a&&console.info("ImageManager->listSize - The size of the list has changed from "+r+" to "+t);y=t;u(r)}else a&&console.info("ImageManager->listSize - The size of the list is't changed: "+r)}});Object.defineProperty(h,"imageListCurrSize",{get:function(){return e.size(p)},set:function(e){}});Object.defineProperty(h,"debug",{get:function(){return a},set:function(e){a=!!e}});Object.defineProperty(h,"srcList",{get:function(){return e.keys(S).map(function(e){return e})},set:function(e){}});Object.defineProperty(h,"cacheLimit",{get:function(){return L.limit},set:function(e){L.limit=e}});h.hasSource=function(e){return e in S};h.loadImage=function(n,t){if(!e.isString(n)||n.length<5){a&&console.info("ImageManager->loadImage() - Wrong SRC: "+n);e.call(t.onError,[{id:-1,src:n,completed:!1}]);return!1}if(h.hasSource(n)){a&&console.info("ImageManager->loadImage() - SRC already exists: "+n);e.call(t.onResolve,[{id:-1,src:n,completed:!0}]);return!1}var r=h.imageListCurrSize;if(r>0&&r+1>h.listSize){var i=l();i.onComplete(i)}b+=1;t=e.extend(R,e.isObject(t)?t:{});t.src=n;t.id=b;S[n]=b;var s=new o(t,h.configGet());s.onComplete=function(e){e.isPaused||(v-=1);e.onDrop();m(e.src,e)}.bind(h);p[b]=s;c();return b};h.configSet=function(n,t){if(e.isObject(n))return e.forEach(n,function(e,n){return h.configSet(n,e)});if(e.isString(n)){var r={fullRepeal:function(n){return e.varFilter(n,"boolean",0,!1)},maxDownloads:function(n){return e.varFilter(n,"number",{type:"number",min:1},1)},onError:function(n){return e.isFunction(n)?n:null},onResolve:function(n){return e.isFunction(n)?n:null},onSuccess:function(n){return e.isFunction(n)?n:null}};e.includes(e.keys(r),n)?R[n]=r[n](t):a&&console.warn("ImageManager->configSet() - There is no such parameter ["+n+"]")}else a&&console.warn("ImageManager->configSet() - Parameter must be string ["+n+"]")};h.pauseBySrc=function(n){if(e.isArray(n))return e.forEach(n,function(e){return h.pauseBySrc(e)});if(!h.hasSource(n)){a&&console.info("ImageManager - > pauseBySrc() - SRC is not added: "+n);return!1}var t=S[n];p[t].isPaused=!0;return!0};h.startBySrc=function(n){if(e.isArray(n))return e.forEach(n,function(e){return h.startBySrc(e)});if(!h.hasSource(n)){a&&console.info("ImageManager->startBySrc() - SRC is not added: "+n);return!1}var t=S[n];p[t].isPaused=!1;c();return!0};h.pauseAll=function(){h.pauseBySrc(e.keys(p))};h.startAll=function(){d(e.keys(p))};h.cacheAdd=function(e){L.add(e)};h.cacheGet=function(e){return L.get(e,!1)};h.cacheRemove=function(e){return L.remove(e)};h.cacheList=function(){return L.keys()};h.cacheClear=function(){L.destroy()};Object.defineProperty(h,"cacheSize",{get:function(){return L.limit},set:function(e){L.limit=e}})}e.MAX_NUMBER=Number.MAX_VALUE;e.call=function(n,t,r){if(arguments.length<3){r=null;arguments.length<2&&(t=[])}e.isFunction(n)&&n.apply(r,t)};e.extend=function(){var n=arguments.length;if(!n)return{};var t=n?arguments[0]:{},r=2>n?{}:arguments[1],o={};if(n>2){for(var i=0;n>=i;i+=1)o=e.extend(o,arguments[i]);return o}for(var a in t)t.hasOwnProperty(a)&&(o[a]=t[a]);for(a in r)r.hasOwnProperty(a)&&(o[a]=r[a]);return o};e.includes=function(n,t){if(e.isArray(n))return Array.includes?n.includes(t):n.indexOf(t)>-1;if(e.isObject(n))for(var r in n)if(n.hasOwnProperty(r)&&n[r]===t)return!0;return!1};e.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)};e.isFunction=function(e){return"function"==typeof e};e.isObject=function(n){return"object"===e.varType(n)};e.isString=function(e){return"string"==typeof e};e.forEach=function(n,t,r,o){if(!e.isObject(n)&&!e.isArray(n))return o?r:n;var i,a=0;if(n.length===+n.length)for(i=n.length;i>a;a+=1)t.call(r,n[a],a,n);else{var c=e.keys(n);for(i=c.length;i>a;a+=1)t.call(r,n[c[a]],c[a],n)}return o?r:n};e.getInPath=function(n,t,r){arguments.length<3&&(r=null);if(!e.isObject(n))return r;if(e.isString(t))return e.has(n,t)?n[t]:r;if("array"!==e.varType(t))return r;var o=0,i=t.length;for(o;i>o;o+=1){var a=t[o];if(!e.has(n,a))return r;n=n[a]}return n};e.has=function(n,t){return"object"===e.varType(n)&&t in n};e.hasType=function(n,t,r){return e.has(n,t)?e.varTypeIn(n[t],r):!1};e.keys=function(e){return Object.keys(e).sort()};e.map=function(n,t,r){var o=[];e.forEach(t,function(){o.push(n.apply(r,arguments))});return o};e.size=function(n){var t=e.varType(n);return"array"===t?n.filter(function(e){return void 0!==e}).length:"object"===t?Object.keys(n).length:!1};e.times=function(e,n){for(var t=new Array(Math.max(0,e)),r=0;e>r;r+=1)t[r]=n.call();return t};e.toArray=function(e,n){var t=[],r=arguments.length>>1?n:0,o=e.length;for(r;o>r;r+=1)t.push(e[r]);return t};e.toNumber=function(n,t,r,o){n=parseFloat(n);if(!isFinite(n)||isNaN(n))return t;n=parseFloat(n.toFixed(0));if(arguments.length<4){o=e.MAX_NUMBER;if(arguments.length<3){r=0;arguments.length<2&&(t=0)}}return isFinite(n)?n>o?o:r>n?r:n:t};e.varFilter=function(n,t,r,o){if(arguments.length<4){o=null;if(arguments.length<3){r={};arguments.length<2&&(t=[])}}if(e.isArray(t)&&t.length){if(!e.varTypeIn(n,t))return o}else if(e.isString(t)&&!e.varTypeIn(n,[t]))return o;if(e.isObject(r)&&e.size(r)||e.isString(r))switch(e.isString(r)?r:r.type){case"boolean":return!!n;case"number":case"integer":case"float":return e.isObject(r)?e.toNumber(n,o,e.getInPath(r,"min",0),e.getInPath(r,"max",e.MAX_NUMBER)):e.toNumber(n,o);default:return o}return n};e.varType=function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()};e.varTypeIn=function(n,t){return"array"===e.varType(t)?!!~t.indexOf(e.varType(n)):e.varType(n)===t+""};n.prototype=new CacheLRU;n.prototype.add=function(n){n instanceof HTMLImageElement&&(n={element:n});if(e.isString(n)){var t=new Image;t.setAttribute("src",n);n={element:t}}n.timestamp=n.timestamp||Date.now();this.put(n.element.src,n);return n};t.isCached=function(e){var n=document.createElement("img");n.src=e;return n.complete||n.width+n.height>0};t.isURL=function(e){if(!e.length||e.length<5)return!1;var n=e.substr(0,4);return"http"===n||"ftp:"===n||"sftp"===n||"//"===n.substr(0,2)};t.fileSize=function(e,n){var t=new XMLHttpRequest;t.open("HEAD",e,!0);t.onreadystatechange=function(){4===t.readyState&&n(200===t.status?t.getResponseHeader("Content-Length"):0)};t.send(null)};t.isInDOM=function(e){if(e===document)return!0;e=e.parentNode;return e?t.isInDOM(e):!1};var a=!1;return i});
//# sourceMappingURL=image-manager.min.js.map